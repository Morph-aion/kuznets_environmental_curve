# Approche Transversale {background-color="#16A085"}

## Photographie du monde en 2020

---

## üåç Vue d'ensemble : Log-log vs Log-lin

```{python}
#| echo: true
#| code-fold: true
#| code-summary: "üìÇ Voir le code de g√©n√©ration"

import matplotlib.pyplot as plt
import seaborn as sns

# S√©lection de pays √† annoter
PAYS_LABELS = {
    'United States': 'USA', 'China': 'CHN', 'India': 'IND', 
    'Qatar': 'QAT', 'France': 'FRA', 'Sweden': 'SWE', 
    'Germany': 'DEU', 'Brazil': 'BRA'
}
```

```{python}
#| echo: false
#| fig-width: 12
#| fig-height: 5

fig, axes = plt.subplots(1, 2, figsize=(12, 5))

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# A. GRAPHIQUE LOG-LOG (Vision √©conom√©trique)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

axes[0].scatter(df_cross['gdp_pc'], df_cross['co2_per_capita'], 
                alpha=0.4, s=50, color='#34495e', edgecolor='white')

axes[0].set_xscale('log')
axes[0].set_yscale('log')
axes[0].set_xlabel("PIB par habitant (USD PPA 2017)", fontsize=11)
axes[0].set_ylabel("$\\mathrm{CO}_2$ par habitant (tonnes)", fontsize=11)
axes[0].set_title("A. √âchelle Log-Log\n(Vision √âconom√©trique)", fontweight='bold', fontsize=12)
axes[0].grid(True, which="both", ls="--", alpha=0.3)

# Annotations
for pays, code in PAYS_LABELS.items():
    row = df_cross[df_cross['country'] == pays]
    if not row.empty:
        x = row['gdp_pc'].values[0]
        y = row['co2_per_capita'].values[0]
        axes[0].text(x, y, f" {code}", fontsize=8, fontweight='bold', 
                     color='#2c3e50', va='bottom')

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# B. GRAPHIQUE LOG-LIN (R√©alit√© physique)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

axes[1].scatter(df_cross['gdp_pc'], df_cross['co2_per_capita'], 
                alpha=0.4, s=50, color='#c0392b', edgecolor='white')

# Tendance LOWESS
from statsmodels.nonparametric.smoothers_lowess import lowess
lowess_result = lowess(df_cross['co2_per_capita'], np.log(df_cross['gdp_pc']), frac=0.3)
axes[1].plot(np.exp(lowess_result[:, 0]), lowess_result[:, 1], 
             color='black', linewidth=2, linestyle='--', label='Tendance moyenne')

axes[1].set_xscale('log')
axes[1].set_xlabel("PIB par habitant (USD PPA 2017)", fontsize=11)
axes[1].set_ylabel("$\\mathrm{CO}_2$ par habitant (tonnes)", fontsize=11)
axes[1].set_title("B. √âchelle Log-Lin√©aire\n(R√©alit√© Physique)", fontweight='bold', fontsize=12)
axes[1].legend(loc='upper left', fontsize=10)
axes[1].grid(True, which="both", ls="--", alpha=0.3)

# Annotations
for pays, code in PAYS_LABELS.items():
    row = df_cross[df_cross['country'] == pays]
    if not row.empty:
        x = row['gdp_pc'].values[0]
        y = row['co2_per_capita'].values[0]
        ha = 'right' if y > 30 else 'left'
        axes[1].text(x, y, f"{code} " if ha == 'right' else f" {code}", 
                     fontsize=8, fontweight='bold', 
                     color='#c0392b', va='center', ha=ha)

plt.tight_layout()
plt.show()
```

::: {.callout-warning}
## Message cl√©

**L'EKC moyenne masque des trajectoires radicalement divergentes**

√Ä PIB comparable (~50 000 $/hab) :
- üá∏üá™ **Su√®de** : 4 t $\mathrm{CO}_2$/hab (nucl√©aire + hydro)
- üá∂üá¶ **Qatar** : 35 t $\mathrm{CO}_2$/hab (gaz + climatisation)

‚Üí **Facteur 9** de diff√©rence ‚Üí Les choix politiques comptent plus que la richesse
:::

::: {.notes}
**Pour l'oral** :

Gauche : En log-log, la relation semble assez lin√©aire (c'est l'espace de travail du mod√®le).

Droite : En √©chelle r√©elle, on voit l'**h√©t√©rog√©n√©it√© explosive** aux hauts revenus.
Le Qatar s'envole, la Su√®de plafonne ‚Üí preuve que l'EKC n'est pas d√©terministe.
:::

---

## üìä R√©sultat cl√© n¬∞1 : Le mod√®le quadratique suffit

```{python}
#| echo: true
#| code-fold: true
#| code-summary: "üìÇ Voir le code d'estimation"

import statsmodels.formula.api as smf
import matplotlib.pyplot as plt
import numpy as np

# Estimation avec erreurs-types robustes HC3
m_quad = smf.ols('log_co2 ~ log_gdp_c + I(log_gdp_c**2)', data=df_cross).fit(cov_type='HC3')
m_cub = smf.ols('log_co2 ~ log_gdp_c + I(log_gdp_c**2) + I(log_gdp_c**3)', data=df_cross).fit(cov_type='HC3')

# Extraction des statistiques cl√©s
beta3 = m_cub.params['I(log_gdp_c ** 3)']
pval3 = m_cub.pvalues['I(log_gdp_c ** 3)']
aic_diff = m_quad.aic - m_cub.aic
```

::: {.columns}

::: {.column width="55%"}
```{python}
#| echo: false
#| fig-width: 6
#| fig-height: 5

# G√©n√©ration de la grille de pr√©diction
log_gdp_c_grid = np.linspace(df_cross['log_gdp_c'].min(), df_cross['log_gdp_c'].max(), 200)
pred_df = pd.DataFrame({'log_gdp_c': log_gdp_c_grid})

# Pr√©dictions des mod√®les ESTIM√âS (pas de r√©-estimation)
pred_quad = m_quad.predict(pred_df)
pred_cub = m_cub.predict(pred_df)

# Graphique
fig, ax = plt.subplots(figsize=(6, 5))

# Points (donn√©es r√©elles)
ax.scatter(df_cross['log_gdp_c'], df_cross['log_co2'], 
           alpha=0.3, color='gray', s=30, label='Observations', zorder=1)

# Courbe Quadratique (Rouge - retenu)
ax.plot(log_gdp_c_grid, pred_quad, 
        color='#d62728', linewidth=2.5, label='Quadratique (retenu)', zorder=3)

# Courbe Cubique (Verte pointill√©e - rejet√©)
ax.plot(log_gdp_c_grid, pred_cub, 
        color='#2ca02c', linewidth=2, linestyle='--', label='Cubique (rejet√©)', zorder=2)

ax.set_xlabel("$\\ln(\\mathrm{PIB})$ centr√©", fontsize=11)
ax.set_ylabel("$\\ln(\\mathrm{CO}_2)$", fontsize=11)
ax.legend(loc='upper left', fontsize=10)
ax.grid(True, alpha=0.3)
plt.tight_layout()
plt.show()
```
:::

::: {.column width="45%"}

```{python}
#| echo: false

# Verdict conditionnel
verdict = "significatif" if pval3 < 0.05 else "non significatif"
conclusion_aic = "Quadratique" if m_quad.aic < m_cub.aic else "Cubique"
emoji_verdict = "‚úÖ" if pval3 < 0.05 else "‚ùå"

display(Markdown(f"""
::: {{.callout-tip icon=false}}
## Verdict Statistique

Le terme cubique est **{verdict.upper()}**.

| Statistique | Valeur |
|-------------|--------|
| $\\beta_3$ | ${beta3:.4f}$ |
| $p$-value | **{pval3:.3f}** |
| $\\mathrm{{AIC}}_{{\\text{{quad}}}}$ | {m_quad.aic:.1f} |
| $\\mathrm{{AIC}}_{{\\text{{cub}}}}$ | {m_cub.aic:.1f} |
:::

**D√©cision m√©thodologique**

‚úÖ Mod√®le retenu : **{conclusion_aic}**

{emoji_verdict} Courbe en N : **{'D√©tect√©e' if pval3 < 0.05 else 'Rejet√©e'}**

‚öñÔ∏è Gain en parcimonie : **${abs(aic_diff):.1f}$** points de $\\Delta \\mathrm{{AIC}}$
"""))
```
:::
:::

::: {.notes}
**Notes pour l'oral** :

√Ä gauche : Les deux courbes (rouge et verte) se superposent presque parfaitement. 
Le cubique n'apporte rien visuellement.

√Ä droite : Statistiquement, $\beta_3 \approx 0$ ($p = 0.995$), donc le terme cubique est inutile.

**Principe de parcimonie** : On garde le mod√®le le plus simple (quadratique).
:::

---

## üìà R√©sultats de l'estimation OLS

::: {style="font-size: 0.75em;"}
| Variable | Lin√©aire | Quadratique | Cubique |
|----------|----------|-------------|---------|
| $\ln(\text{PIB})$ centr√© | 1.1000*** | 1.0698*** | 1.0703*** |
|  | (0.0427) | (0.0431) | (0.0825) |
| $[\ln(\text{PIB})]^2$ | ‚Äî | -0.0832*** | -0.0833** |
|  |  | (0.0315) | (0.0400) |
| $[\ln(\text{PIB})]^3$ | ‚Äî | ‚Äî | -0.0002 |
|  |  |  | (0.0268) |
| **$R^2$ ajust√©** | 0.836 | 0.842 | 0.841 |
| **AIC** | 279.6 | 274.0 | 276.0 |
| **N** | 159 | 159 | 159 |
:::

*Erreurs-types robustes HC3 entre parenth√®ses. \*p<0.1, \*\*p<0.05, \*\*\*p<0.01*

::: {.callout-note}
## Interpr√©tation
- Mod√®le quadratique : meilleur compromis $R^2$ / AIC
- $\beta_2 < 0$ significatif ‚Üí U invers√© valid√©
- $\beta_3$ non significatif ‚Üí pas de rebond d√©tect√©
:::

---

## üéØ Performance pr√©dictive : Validation crois√©e (k=5)

::: {style="text-align: center; font-size: 1.5em; margin: 2em 0;"}
**RMSE moyen**

| Mod√®le | RMSE | Œî vs quadratique |
|--------|------|------------------|
| Lin√©aire | 0.5798 | +2.0% |
| **Quadratique** | **0.5683** | **r√©f√©rence** |
| Cubique | 0.5796 | **-2.0%** ‚ö†Ô∏è |
:::

::: {.callout-warning}
## Interpr√©tation
Le mod√®le cubique **sur-apprend** les donn√©es de 2020

‚Üí Quadratique g√©n√©ralise mieux √† de nouveaux pays

‚Üí **Parcimonie confirm√©e**
:::

---

## üîç Diagnostic des erreurs : Qui le mod√®le rate-t-il ?

```{python}
#| echo: true
#| code-fold: true
#| code-summary: "üìÇ Voir le code d'analyse des r√©sidus"

import matplotlib.pyplot as plt
import seaborn as sns
import numpy as np

# Calcul des r√©sidus (si mod√®le pas d√©j√† estim√©)
if 'm_quad' not in locals():
    m_quad = smf.ols('log_co2 ~ log_gdp_c + I(log_gdp_c**2)', data=df_cross).fit(cov_type='HC3')

# Pr√©dictions et r√©sidus
df_cross['pred_quad'] = m_quad.predict(df_cross)
df_cross['resid'] = df_cross['log_co2'] - df_cross['pred_quad']
df_cross['resid_abs'] = np.abs(df_cross['resid'])

# Identification des pays extr√™mes
top_over = df_cross.nlargest(5, 'resid')   # Sous-estim√©s (polluent PLUS)
top_under = df_cross.nsmallest(5, 'resid') # Surestim√©s (polluent MOINS)
```

::: {.panel-tabset}

### üìä Carte des erreurs

```{python}
#| echo: false
#| fig-width: 10
#| fig-height: 6

fig, ax = plt.subplots(figsize=(10, 6))

# Points : taille proportionnelle √† l'erreur absolue
scatter = ax.scatter(df_cross['log_gdp_c'], df_cross['log_co2'], 
                     c=df_cross['resid'], 
                     s=df_cross['resid_abs']*200 + 20,  # Taille = magnitude erreur
                     cmap='RdYlGn_r',  # Rouge = sous-estim√©, Vert = surestim√©
                     alpha=0.6, 
                     edgecolor='black', 
                     linewidth=0.5)

# Courbe ajust√©e
log_gdp_grid = np.linspace(df_cross['log_gdp_c'].min(), df_cross['log_gdp_c'].max(), 200)
pred_grid = m_quad.predict(pd.DataFrame({'log_gdp_c': log_gdp_grid}))
ax.plot(log_gdp_grid, pred_grid, 'b-', linewidth=2.5, label='Mod√®le quadratique')

# Annotations des pays extr√™mes
for _, row in pd.concat([top_over.head(3), top_under.head(3)]).iterrows():
    ax.annotate(row['country'], 
                (row['log_gdp_c'], row['log_co2']),
                xytext=(5, 5), textcoords='offset points',
                fontsize=8, fontweight='bold',
                bbox=dict(boxstyle='round,pad=0.3', 
                         facecolor='yellow' if row['resid'] > 0 else 'lightgreen', 
                         alpha=0.7))

# Colorbar
cbar = plt.colorbar(scatter, ax=ax)
cbar.set_label('R√©sidu (rouge = pollue PLUS que pr√©vu)', fontsize=10)

ax.set_xlabel("$\\ln(\\mathrm{PIB})$ centr√©", fontsize=12)
ax.set_ylabel("$\\ln(\\mathrm{CO}_2)$", fontsize=12)
ax.set_title("Analyse des erreurs de pr√©diction", fontweight='bold', fontsize=13)
ax.legend(loc='upper left')
ax.grid(True, alpha=0.3)

plt.tight_layout()
plt.show()
```

### üî¥ Top 5 sous-estim√©s

```{python}
#| echo: false

# Conversion en tonnes pour interpr√©tation
top_over['co2_obs'] = np.exp(top_over['log_co2'])
top_over['co2_pred'] = np.exp(top_over['pred_quad'])
top_over['erreur_tonnes'] = top_over['co2_obs'] - top_over['co2_pred']

display(Markdown(f"""
**Pays qui polluent PLUS que pr√©vu** (mod√®le sous-estime) :

| Pays | CO‚ÇÇ observ√© | CO‚ÇÇ pr√©dit | Erreur |
|------|-------------|------------|--------|
""" + "\n".join([
    f"| {row['country']} | {row['co2_obs']:.1f} t | {row['co2_pred']:.1f} t | **+{row['erreur_tonnes']:.1f} t** |"
    for _, row in top_over.head(5).iterrows()
]) + """

**Profil** : √âconomies p√©troli√®res (Qatar, Kowe√Øt), exportateurs de charbon (Australie), climat extr√™me (Arabie Saoudite).
"""))
```

### üü¢ Top 5 surestim√©s

```{python}
#| echo: false

top_under['co2_obs'] = np.exp(top_under['log_co2'])
top_under['co2_pred'] = np.exp(top_under['pred_quad'])
top_under['erreur_tonnes'] = top_under['co2_obs'] - top_under['co2_pred']

display(Markdown(f"""
**Pays qui polluent MOINS que pr√©vu** (mod√®le surestime) :

| Pays | CO‚ÇÇ observ√© | CO‚ÇÇ pr√©dit | Erreur |
|------|-------------|------------|--------|
""" + "\n".join([
    f"| {row['country']} | {row['co2_obs']:.1f} t | {row['co2_pred']:.1f} t | **{row['erreur_tonnes']:.1f} t** |"
    for _, row in top_under.head(5).iterrows()
]) + """

**Profil** : D√©carbon√©s volontaristes (France, Su√®de : nucl√©aire/hydro), champions de l'efficacit√© √©nerg√©tique (Suisse, Islande).
"""))
```

:::

::: {.callout-important}
## Message cl√©

√Ä **PIB √©gal**, la Su√®de √©met **9 fois moins** que le Qatar

‚Üí Les **choix politiques** comptent plus que la richesse seule
:::

---

## üó∫Ô∏è Profils des pays mal pr√©dits

::: {.columns}
::: {.column width="50%"}
::: {.callout-note collapse="false"}
## üî¥ Pays **sous-estim√©s** (polluent PLUS)
**30 pays** | PIB moyen : 18 275 \$/hab

**Profil** : √âconomies fossiles

- üõ¢Ô∏è Qatar, Kowe√Øt, Bahre√Øn (rente p√©troli√®re)
- ‚õèÔ∏è Australie, Afrique du Sud (exportateurs charbon)
- üå°Ô∏è Arabie Saoudite (climatisation intensive)
:::
:::

::: {.column width="50%"}
::: {.callout-note collapse="false"}
## üü¢ Pays **surestim√©s** (polluent MOINS)
**26 pays** | PIB moyen : 17 398 \$/hab

**Profil** : D√©carbon√©s volontaristes

- ‚ö° France, Su√®de (nucl√©aire 70%, hydro 45%)
- üå± Islande, Norv√®ge (100% renouvelables)
- üèîÔ∏è Suisse (efficacit√© √©nerg√©tique)
:::
:::
:::

::: {.callout-important}
## Message cl√©
√Ä **PIB √©gal**, la Su√®de √©met **9 fois moins** que le Qatar

‚Üí Les **choix politiques** comptent plus que la richesse seule
:::

---

## üìù Bilan de l'approche transversale

::: {.incremental}
‚úÖ **EKC classique valid√©e** : relation en U invers√© confirm√©e ($\beta_2 < 0$, p < 0.001)

‚úÖ **Courbe en N rejet√©e** : pas de rebond aux tr√®s hauts revenus ($\beta_3 \approx 0$, p = 0.995)

‚úÖ **D√©couplage possible** : les pays riches √©mettent moins (turning point franchi pour OCDE)

‚ö†Ô∏è **H√©t√©rog√©n√©it√© masqu√©e** : l'EKC moyenne cache 3 clubs de pays (d√©carbon√©s / sur-carbon√©s / en transition)

‚ùì **Questions restantes** :

- Ce d√©couplage est-il **durable** dans le temps ?
- L'**inertie** des syst√®mes √©nerg√©tiques permet-elle une transition rapide ?
- Un pays peut-il **revenir en arri√®re** apr√®s d√©couplage ?
:::

::: {.fragment}
::: {style="text-align: center; font-size: 1.3em; color: #16A085; margin-top: 1em;"}
**‚Üí Partie III : Analyse temporelle du cas am√©ricain (1990-2020)**
:::
:::
